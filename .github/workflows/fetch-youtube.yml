name: Fetch YouTube Data

on:
  schedule:
    # Run daily at 6 AM UTC (midnight MDT)
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write

jobs:
  fetch-shorts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch latest shorts and channel stats from YouTube
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
          CHANNEL_ID: UC88w6T7O_jV_G5eSUWBhVVw
        run: |
          # Fetch recent videos from channel (shorts are videos under 60 seconds)
          response=$(curl -s "https://www.googleapis.com/youtube/v3/search?key=${YOUTUBE_API_KEY}&channelId=${CHANNEL_ID}&part=snippet&order=date&maxResults=20&type=video")

          # Extract video IDs
          video_ids=$(echo "$response" | jq -r '.items[].id.videoId' | tr '\n' ',' | sed 's/,$//')

          # Get video details including duration
          details=$(curl -s "https://www.googleapis.com/youtube/v3/videos?key=${YOUTUBE_API_KEY}&id=${video_ids}&part=contentDetails,snippet")

          # Filter for shorts (duration <= 60 seconds)
          shorts=$(echo "$details" | jq '[.items[] |
            select(.contentDetails.duration | test("^PT([0-5]?[0-9]S|1M)$")) |
            {
              id: .id,
              title: .snippet.title,
              thumbnail: .snippet.thumbnails.high.url,
              publishedAt: .snippet.publishedAt
            }
          ] | .[0:6]')

          # Fetch channel statistics
          channel=$(curl -s "https://www.googleapis.com/youtube/v3/channels?key=${YOUTUBE_API_KEY}&id=${CHANNEL_ID}&part=statistics")

          # Fetch playlist count
          playlists=$(curl -s "https://www.googleapis.com/youtube/v3/playlists?key=${YOUTUBE_API_KEY}&channelId=${CHANNEL_ID}&part=snippet&maxResults=1")
          playlist_count=$(echo "$playlists" | jq '.pageInfo.totalResults')

          # Combine shorts and stats into single JSON
          jq -n --argjson shorts "$shorts" --argjson channel "$channel" --argjson playlistCount "$playlist_count" '{
            shorts: $shorts,
            stats: {
              subscriberCount: $channel.items[0].statistics.subscriberCount,
              videoCount: $channel.items[0].statistics.videoCount,
              viewCount: $channel.items[0].statistics.viewCount,
              playlistCount: ($playlistCount | tostring),
              updatedAt: (now | strftime("%Y-%m-%dT%H:%M:%SZ"))
            }
          }' > youtube.json

          # Show what we got
          echo "Fetched data:"
          cat youtube.json

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add youtube.json
          git diff --quiet --staged || (git commit -m "Update YouTube data" && git push)
